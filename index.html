<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phone Manager PRO - AbstractAPI</title>
    <style>
        :root {
            --bg: #050505; --card: #0f0f0f; --accent: #ff006e; --border: #1f1f1f; --text: #fff;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding: 25px; margin: 0; }
        .dashboard { display: grid; grid-template-columns: 380px 1fr; gap: 25px; max-width: 1600px; margin: 0 auto; }
        
        /* Panneau de Contr√¥le */
        .sidebar { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 20px; height: 90vh; position: sticky; top: 20px; }
        h2 { font-size: 1.2rem; color: var(--accent); margin-bottom: 20px; }
        
        textarea { width: 100%; height: 350px; background: #000; border: 1px solid var(--border); color: #00ff88; border-radius: 8px; padding: 10px; font-family: monospace; margin-bottom: 15px; resize: none; }
        .btn-run { width: 100%; padding: 15px; background: var(--accent); color: #fff; border: none; font-weight: bold; border-radius: 8px; cursor: pointer; text-transform: uppercase; }
        .progress { font-size: 12px; margin-top: 10px; color: #666; }

        /* Grille des Compartiments */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .op-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .op-header { background: #151515; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid var(--border); }
        
        .num-item { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #111; font-family: monospace; }
        .check-used { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }

        /* Archive */
        .archive-section { margin-top: 40px; border-top: 2px dashed #1a1a1a; padding-top: 20px; opacity: 0.5; }
        .archived-num { display: inline-block; background: #111; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin: 3px; color: #444; text-decoration: line-through; }
    </style>
</head>
<body>

<div class="dashboard">
    <aside class="sidebar">
        <h2>Import de Masse</h2>
        <div style="font-size: 11px; color: #555; margin-bottom: 10px;">API : AbstractAPI (Lookup 10k+)</div>
        
        <textarea id="massInput" placeholder="Colle ta liste ici..."></textarea>
        
        <div id="status" class="progress">Attente...</div>
        <button class="btn-run" onclick="startAPIProcess()">Lancer la v√©rification</button>
        
        <button class="btn-run" style="margin-top:10px; background:transparent; border:1px solid #333;" onclick="downloadJSON()">T√©l√©charger JSON</button>
    </aside>

    <main>
        <div id="opGrid" class="grid">
            </div>

        <div class="archive-section">
            <h3>üìÅ COMPARTIMENT ARCHIVE (D√âJ√Ä UTILIS√âS)</h3>
            <div id="archiveList"></div>
        </div>
    </main>
</div>

<script>
    const API_KEY = '8de8de90e9a3458e9112c4c7daf3eb5b';
    let db = JSON.parse(localStorage.getItem('phone_db_v3')) || { active: {}, archived: [] };

    async function startAPIProcess() {
        const input = document.getElementById('massInput');
        const status = document.getElementById('status');
        const lines = input.value.split('\n').filter(l => l.trim().length >= 10);
        
        input.value = ""; // Vider pour lib√©rer la m√©moire

        for (let i = 0; i < lines.length; i++) {
            const phone = lines[i].trim();
            status.innerText = `Traitement: ${i+1}/${lines.length}...`;

            try {
                const response = await fetch(`https://phonevalidation.abstractapi.com/v1/?api_key=${API_KEY}&number=${phone}`);
                const data = await response.json();

                if (data.valid) {
                    const carrier = data.carrier || "Inconnu";
                    if (!db.active[carrier]) db.active[carrier] = [];
                    
                    // Doublon check
                    if (!db.active[carrier].some(x => x.num === data.format.international)) {
                        db.active[carrier].push({
                            id: Date.now() + i,
                            num: data.format.international,
                            type: data.type
                        });
                    }
                }
            } catch (e) { console.error("Erreur API"); }

            // D√©lai pour ne pas √™tre banni (Rate Limit)
            await new Promise(r => setTimeout(r, 150));
            if (i % 5 === 0) render(); // Update visuel r√©gulier
        }
        
        status.innerText = "Termin√© !";
        save();
    }

    function moveToArchive(op, id) {
        const idx = db.active[op].findIndex(n => n.id === id);
        const item = db.active[op].splice(idx, 1)[0];
        
        db.archived.push({ ...item, op: op });
        if (db.active[op].length === 0) delete db.active[op];
        save();
    }

    function save() {
        localStorage.setItem('phone_db_v3', JSON.stringify(db));
        render();
    }

    function downloadJSON() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db, null, 2));
        const dlAnchor = document.createElement('a');
        dlAnchor.setAttribute("href", dataStr);
        dlAnchor.setAttribute("download", "database_numeros.json");
        dlAnchor.click();
    }

    function render() {
        const grid = document.getElementById('opGrid');
        const arch = document.getElementById('archiveList');
        grid.innerHTML = '';
        arch.innerHTML = '';

        Object.keys(db.active).forEach(op => {
            let card = `<div class="op-card"><div class="op-header">${op} <span>${db.active[op].length}</span></div>`;
            db.active[op].forEach(n => {
                card += `
                    <div class="num-item">
                        <span>${n.num}</span>
                        <input type="checkbox" class="check-used" onchange="moveToArchive('${op}', ${n.id})">
                    </div>`;
            });
            grid.innerHTML += card + `</div>`;
        });

        db.archived.forEach(n => {
            arch.innerHTML += `<span class="archived-num">${n.num}</span>`;
        });
    }

    render();
</script>
</body>
</html>
